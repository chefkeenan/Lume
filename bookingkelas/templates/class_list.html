{% extends "base.html" %}
{% block content %}
<div class="mx-auto max-w-5xl px-6 py-10">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">All Sessions</h1>
    <a href="{% url 'bookingkelas:catalog' %}" class="text-stone-800 hover:underline">&larr; Back to Catalog</a>
  </div>

  <table class="table w-full border-collapse text-left">
    <thead>
      <tr class="border-b">
        <th class="p-2">Title</th>
        <th class="p-2">Category</th>
        <th class="p-2">Time</th>
        <th class="p-2">Capacity</th>
        <th class="p-2"></th>
      </tr>
    </thead>
    <tbody>
      {% for s in classes %}
      <tr class="border-b hover:bg-gray-50">
        <td class="p-2">{{ s.title }}</td>
        <td class="p-2">{{ s.category|title }}</td>
        <td class="p-2">{{ s.time }}</td>
        <td class="p-2">{{ s.capacity_current }}/{{ s.capacity_max }}</td>
        <td class="p-2 text-right">

          <button type="button" class="edit-session-btn text-blue-600 hover:underline"
            data-form-url="{% url 'bookingkelas:get_edit_form' s.pk %}"
            data-post-url="{% url 'bookingkelas:class_edit' s.pk %}">
            Edit
          </button>

          <button type="button" class="delete-session-btn text-red-600 hover:underline"
            data-delete-modal-url="{% url 'bookingkelas:class_delete' s.pk %}"> 
            Delete
          </button>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" class="p-2 text-center text-gray-500">Empty.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% include "modal_edit.html" %}
{% include "delete_modal.html" %}

{% endblock %}

{% block scripts %}
<style>
  /* Container untuk form fields */
  .modal-form-fields {
    /* Gunakan CSS Grid untuk layout 2 kolom */
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    /* Membuat 2 kolom dengan lebar yang sama */
    gap: 10px;
    /* Jarak antar kolom dan baris */
  }

  /* Styling untuk setiap field (dibungkus oleh <p>) */
  .modal-form-fields p {
    display: flex;
    flex-direction: column;
    gap: 2px;
    /* Tambahkan ini jika ada field yang ingin tetap 1 kolom penuh, contoh description */
    /* Contoh: .modal-form-fields p:has(label[for="id_description"]) { grid-column: span 2; } */
  }

  /* Lebar untuk beberapa field agar tidak terlalu panjang */
  .modal-form-fields p:has(label[for="id_title"]),
  .modal-form-fields p:has(label[for="id_description"]) {
    grid-column: span 2;
    /* Buat Title dan Description mengambil 2 kolom penuh */
  }

  /* Styling label, input, select, textarea */
  .modal-form-fields label {
    font-weight: 600;
    font-size: 0.9rem;
    color: #374151;
  }

  .modal-form-fields input[type="text"],
  .modal-form-fields input[type="number"],
  .modal-form-fields select,
  .modal-form-fields textarea {
    width: 100%;
    border: 1px solid #D1D5DB;
    border-radius: 8px;
    padding: 8px 12px;
  }

  .modal-form-fields .helptext {
    font-size: 0.8rem;
    color: #6B7280;
  }

  /* Merapikan layout checkbox 'Days' */
  .modal-form-fields #id_days {
    grid-column: span 2;
    /* Pastikan 'Days' selalu 2 kolom */
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 4px;
    border: 1px solid #D1D5DB;
    border-radius: 8px;
    padding: 12px;
  }

  .modal-form-fields #id_days li {
    display: block;
  }

  .modal-form-fields #id_days label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 400;
  }

  .modal-form-fields #id_days input[type="checkbox"] {
    width: auto;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // === BAGIAN MODAL EDIT (Biarkan) ===
    const editModal = document.getElementById('editSessionModal');
    const editModalPanel = document.getElementById('editModalPanel');
    const editModalBody = document.getElementById('editModalBody');
    const editModalForm = document.getElementById('editModalForm');
    const editModalTitle = document.getElementById('editModalTitle');
    const editModalClose = document.getElementById('editModalClose');
    const editModalCancel = document.getElementById('editModalCancel');

    const openEditModal = () => {
      editModal.classList.remove('opacity-0', 'invisible');
      editModalPanel.classList.remove('opacity-0', 'scale-95');
    };

    const closeEditModal = () => {
      editModal.classList.add('opacity-0');
      editModalPanel.classList.add('opacity-0', 'scale-95');
      setTimeout(() => {
        editModal.classList.add('invisible');
        editModalBody.innerHTML = '<div class="text-gray-500">Loading...</div>';
        editModalForm.action = "";
        editModalTitle.innerText = "Loading...";
      }, 300);
    };

    editModalClose.addEventListener('click', closeEditModal);
    editModalCancel.addEventListener('click', closeEditModal);
    editModal.addEventListener('click', (e) => {
      if (e.target === editModal) closeEditModal();
    });

    // === BAGIAN MODAL DELETE (BARU) ===
    const deleteModal = document.getElementById('deleteModal');
    const deleteModalPanel = document.getElementById('deleteModalPanel');
    const deleteModalForm = document.getElementById('deleteModalForm');
    const deleteModalClose = document.getElementById('deleteModalClose');
    const deleteModalCancel = document.getElementById('deleteModalCancel');

    const openDeleteModal = () => {
      deleteModal.classList.remove('opacity-0', 'invisible');
      deleteModalPanel.classList.remove('opacity-0', 'scale-95');
    };

    const closeDeleteModal = () => {
      deleteModal.classList.add('opacity-0');
      deleteModalPanel.classList.add('opacity-0', 'scale-95');
      setTimeout(() => {
        deleteModal.classList.add('invisible');
        deleteModalForm.action = ""; // Reset action
      }, 300);
    };

    deleteModalClose.addEventListener('click', closeDeleteModal);
    deleteModalCancel.addEventListener('click', closeDeleteModal);
    deleteModal.addEventListener('click', (e) => {
      if (e.target === deleteModal) closeDeleteModal();
    });


    // === EVENT DELEGATION (Modifikasi) ===
    document.body.addEventListener('click', (e) => {

      // Listener untuk tombol EDIT (Biarkan)
      if (e.target.matches('.edit-session-btn')) {
        const formUrl = e.target.dataset.formUrl;
        const postUrl = e.target.dataset.postUrl;
        editModalForm.action = postUrl;
        openEditModal();
        // ... (fetch dan sisa logika edit) ...
        fetch(formUrl).then(response => response.text()).then(html => {
          editModalBody.innerHTML = html;
          editModalTitle.innerText = "Edit Session";
          // ... (logika JS counter & days) ...
        });
      }

      // Listener untuk tombol DELETE (BARU)
      if (e.target.matches('.delete-session-btn')) {
        const deleteUrl = e.target.dataset.deleteModalUrl;
        // Set action form di modal delete
        deleteModalForm.action = deleteUrl;
        // Buka modal delete
        openDeleteModal();
      }
    });
  });
</script>
{% endblock %}
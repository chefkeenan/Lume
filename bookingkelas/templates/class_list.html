{% extends "base.html" %}
{% block content %}
<div class="mx-auto max-w-5xl px-6 py-10">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">All Sessions</h1>
    <a href="{% url 'bookingkelas:catalog' %}" class="text-stone-800 hover:underline">&larr; Back to Catalog</a>
  </div>

  <table class="table w-full border-collapse text-left">
    <thead>
      <tr class="border-b">
        <th class="p-2">Title</th>
        <th class="p-2">Category</th>
        <th class="p-2">Time</th>
        <th class="p-2">Capacity</th>
        <th class="p-2"></th>
      </tr>
    </thead>
    <tbody>
      {% for s in classes %}
      <tr class="border-b hover:bg-gray-50">
        <td class="p-2">{{ s.title }}</td>
        <td class="p-2">{{ s.category|title }}</td>
        <td class="p-2">{{ s.time }}</td>
        <td class="p-2">{{ s.capacity_current }}/{{ s.capacity_max }}</td>
        <td class="p-2 text-right">

          <button type="button" class="edit-session-btn text-blue-600 hover:underline"
            data-form-url="{% url 'bookingkelas:get_edit_form' s.pk %}"
            data-post-url="{% url 'bookingkelas:class_edit' s.pk %}">
            Edit
          </button>

          <button type="button" class="delete-session-btn text-red-600 hover:underline"
            data-delete-modal-url="{% url 'bookingkelas:class_delete' s.pk %}"> 
            Delete
          </button>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" class="p-2 text-center text-gray-500">Empty.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% include "modal_edit.html" %}
{% include "delete_modal.html" %}

{% endblock %}

{% block scripts %}
<style>
  .modal-form-fields {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;

  }

  .modal-form-fields p {
    display: flex;
    flex-direction: column;
    gap: 2px;

  }

  .modal-form-fields p:has(label[for="id_title"]),
  .modal-form-fields p:has(label[for="id_description"]) {
    grid-column: span 2;
  }

  .modal-form-fields label {
    font-weight: 600;
    font-size: 0.9rem;
    color: #374151;
  }

  .modal-form-fields input[type="text"],
  .modal-form-fields input[type="number"],
  .modal-form-fields select,
  .modal-form-fields textarea {
    width: 100%;
    border: 1px solid #D1D5DB;
    border-radius: 8px;
    padding: 8px 12px;
  }

  .modal-form-fields .helptext {
    font-size: 0.8rem;
    color: #6B7280;
  }

  .modal-form-fields #id_days {
    grid-column: span 2;

    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 4px;
    border: 1px solid #D1D5DB;
    border-radius: 8px;
    padding: 12px;
  }

  .modal-form-fields #id_days li {
    display: block;
  }

  .modal-form-fields #id_days label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 400;
  }

  .modal-form-fields #id_days input[type="checkbox"] {
    width: auto;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const editModal      = document.getElementById('editSessionModal');
  const editModalBody  = document.getElementById('editModalBody');
  const editModalForm  = document.getElementById('editModalForm');
  const editModalTitle = document.getElementById('editModalTitle');
  const editModalClose = document.getElementById('editModalClose');
  const editModalCancel= document.getElementById('editModalCancel');

  function openEditModal() {
    if (!editModal) return;
    editModal.classList.remove('hidden');
  }
  function closeEditModal() {
    if (!editModal) return;
    editModal.classList.add('hidden');
    if (editModalBody)  editModalBody.innerHTML = '<div class="text-gray-500">Loading...</div>';
    if (editModalForm)  editModalForm.action = "";
    if (editModalTitle) editModalTitle.innerText = "Loading...";
  }

  editModalClose?.addEventListener('click', closeEditModal);
  editModalCancel?.addEventListener('click', closeEditModal);
  editModal?.addEventListener('click', (e) => { if (e.target === editModal) closeEditModal(); });

   const deleteModal      = document.getElementById('deleteModal');
  const deleteModalPanel = document.getElementById('deleteModalPanel');
  const deleteModalForm  = document.getElementById('deleteModalForm');
  const deleteModalClose = document.getElementById('deleteModalClose');
  const deleteModalCancel= document.getElementById('deleteModalCancel');

  function openDeleteModal() {
    if (!deleteModal) return;
    deleteModal.classList.remove('opacity-0','invisible');
    requestAnimationFrame(() => {
      deleteModalPanel?.classList.remove('opacity-0','scale-95');
    });
  }

  function closeDeleteModal() {
    if (!deleteModal) return;
    deleteModalPanel?.classList.add('opacity-0','scale-95');
    deleteModal.classList.add('opacity-0');
    setTimeout(() => {
      deleteModal.classList.add('invisible');
      if (deleteModalForm) deleteModalForm.action = '';
    }, 300);
  }

  deleteModalClose?.addEventListener('click', closeDeleteModal);
  deleteModalCancel?.addEventListener('click', closeDeleteModal);
  deleteModal?.addEventListener('click', (e) => {
    if (e.target === deleteModal) closeDeleteModal();
  });

  document.body.addEventListener('click', (e) => {
    if (e.target.matches('.edit-session-btn')) {
      const formUrl = e.target.dataset.formUrl;
      const postUrl = e.target.dataset.postUrl;
      if (!formUrl || !postUrl) return;

      const editModal      = document.getElementById('editSessionModal');
      const editModalBody  = document.getElementById('editModalBody');
      const editModalForm  = document.getElementById('editModalForm');
      const editModalTitle = document.getElementById('editModalTitle');

      editModalForm.action = postUrl;
      editModal.classList.remove('hidden');

      fetch(formUrl).then(r=>r.text()).then(html=>{
        editModalBody.innerHTML = html;
        editModalTitle.innerText = 'Edit Session';
      }).catch(()=>{
        editModalBody.innerHTML = '<div class="text-red-600">Gagal memuat form.</div>';
      });
    }

    if (e.target.matches('.delete-session-btn')) {
      const deleteUrl = e.target.dataset.deleteModalUrl || '';
      if (deleteModalForm) deleteModalForm.action = deleteUrl;
      openDeleteModal();
    }
  });
});
</script>
</script>
{% endblock %}
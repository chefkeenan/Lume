{% load humanize %}

<article
  id="card-{{ p.id }}"
  class="relative relative z-0 w-full max-w-[312px] h-full flex flex-col rounded-[18px]
         border border-[#CFC8BA] bg-[#E9E3D6] p-4 shadow-md
         transition-transform duration-200 hover:-translate-y-1 hover:shadow-lg">

  <header class="mb-3">
    <h3 class="text-[20px] font-semibold leading-6 text-neutral-900 h-[52px] line-clamp-2">
      <a href="{% url 'catalog:detail' p.id %}" class="hover:opacity-80">{{ p.product_name }}</a>
    </h3>
  </header>

  <div class="relative overflow-hidden rounded-[14px] border border-[#D7D1C4]">
    <a href="{% url 'catalog:detail' p.id %}">
      <img
        src="{{ p.proxied_thumbnail|default:'https://picsum.photos/seed/pilates/960/640' }}"
        alt="{{ p.product_name }}"
        class="w-full aspect-[4/3] object-cover"
        onerror="this.onerror=null;this.src='https://picsum.photos/seed/pilates-fallback/960/640';"
      />
    </a>

    {% if not p.inStock %}
      <div class="absolute inset-0 grid place-items-center bg-black/40">
        <span class="rounded-full bg-white/90 px-4 py-2 text-sm font-semibold text-gray-800">Out of Stock</span>
      </div>
    {% endif %}

    {% if p.is_best_seller or p.tag == 'Best-seller' %}
      <span class="absolute left-3 bottom-3 rounded-[10px] border border-[#B9C8B6] bg-[#E3EADF] px-2.5 py-1 text-[12px] font-semibold text-[#6B7C68]">
        Best-seller
      </span>
    {% endif %}
  </div>

  <div class="mt-4"></div>

  <div class="mt-auto">
    <p class="text-[22px] font-extrabold tracking-tight text-neutral-900">Rp {{ p.price|intcomma }}</p>

    <div class="mt-3 flex items-center justify-between gap-3">
      {% if p.inStock and user.is_authenticated %}
        <form method="post" action="{% url 'cart:add' p.id %}" class="m-0 p-0 w-full" data-cart-ajax data-product-id="{{ p.id }}">
          {% csrf_token %}
          <input type="hidden" name="qty" value="1">
          <button type="submit"
            class="w-full inline-flex items-center justify-center gap-2 rounded-xl border border-[#C9C7C0] bg-[#D7D6D1] px-4 py-2 text-[14px] font-semibold text-[#5C5B57] shadow-[0_1px_0_#0f0f0f] transition hover:bg-[#CECDC8]">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4 w-4" fill="currentColor"><path d="M7 4H4v2h2l3.6 7.6-1.2 2.2A2 2 0 0 0 10 19h10v-2H10.4l1-2H18a2 2 0 0 0 1.8-1.1l3.2-6.5A1 1 0 0 0 22 6H6.2L5.3 4.2A1 1 0 0 0 4.4 4H2v2h1.6l3.2 6.4L5.2 15.2A4 4 0 0 0 10 21h11v-2H10a2 2 0 0 1-1.8-2.9L9 14"/></svg>
            Add to Cart
          </button>
        </form>

      {% elif not p.inStock %}
        <button disabled
          class="w-full cursor-not-allowed rounded-xl border border-[#C9C7C0] bg-[#D7D6D1] px-4 py-2 text-[14px] font-semibold text-[#5C5B57] opacity-60">
          Out of Stock
        </button>
      {% else %}
        <a href="{% url 'user:login' %}"
          class="w-full inline-flex items-center justify-center gap-2 rounded-xl border border-[#C9C7C0] bg-[#D7D6D1] px-4 py-2 text-[14px] font-semibold text-[#5C5B57] shadow-[0_1px_0_#0f0f0f] transition hover:bg-[#CECDC8]">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4 w-4" fill="currentColor"><path d="M7 4H4v2h2l3.6 7.6-1.2 2.2A2 2 0 0 0 10 19h10v-2H10.4l1-2H18a2 2 0 0 0 1.8-1.1l3.2-6.5A1 1 0 0 0 22 6H6.2L5.3 4.2A1 1 0 0 0 4.4 4H2v2h1.6l3.2 6.4L5.2 15.2A4 4 0 0 0 10 21h11v-2H10a2 2 0 0 1-1.8-2.9L9 14"/></svg>
          Add to Cart
        </a>
      {% endif %}
    </div>

    <div class="mt-3 flex items-center gap-4 text-[14px]">
      <a href="{% url 'catalog:detail' p.id %}" class="underline decoration-1 underline-offset-2 hover:opacity-80">Detail</a>
      {% if user.is_staff %}
        <button type="button"
                data-open-edit
                data-edit-url="{% url 'catalog:product_edit_modal' p.id %}"
                class="underline decoration-1 underline-offset-2 hover:opacity-80">Edit</button>
        <button type="button"
                data-delete-url="{% url 'catalog:product_delete' p.id %}"
                data-card-id="card-{{ p.id }}"
                class="text-red-600 underline decoration-1 underline-offset-2 hover:opacity-80">Delete</button>
      {% endif %}
    </div>
  </div>

  <span class="pointer-events-none absolute inset-0 rounded-[18px] ring-1 ring-black/10"></span>
</article>

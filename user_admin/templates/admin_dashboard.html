{% extends "base.html" %}
{% load static humanize %}

{% block title %}Admin Dashboard — Lume{% endblock %}

{% block content %}


<main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10">
  <div class="mb-10">
    <h1 class="text-4xl font-light text-stone-900 mb-2">Admin Dashboard</h1>
    <p class="text-stone-600">View orders, bookings, users, and view analytics</p>
  </div>

  <!-- Stats -->
  <div id="stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
    <!-- diisi via JS -->
  </div>

  <!-- Tabs -->
  <div class="flex gap-4 mb-6 border-b border-stone-200 overflow-x-auto" id="tabs">
    <button data-tab="overview" class="tab-btn px-4 py-3 font-semibold text-primary border-b-2 border-primary">Overview</button>
    <button data-tab="orders"   class="tab-btn px-4 py-3 font-semibold text-stone-500 hover:text-stone-800">Orders</button>
    <button data-tab="bookings" class="tab-btn px-4 py-3 font-semibold text-stone-500 hover:text-stone-800">Bookings</button>
    <button data-tab="users"    class="tab-btn px-4 py-3 font-semibold text-stone-500 hover:text-stone-800">Users</button>
  </div>

  <!-- Panels -->
  <section id="panel-overview" class="space-y-8">
    <div class="bg-[#ede9de] border border-stone-300 rounded-xl p-6">
      <h2 class="text-2xl font-light text-stone-900 mb-4">Recent Activity</h2>
      <div id="recent-activity" class="divide-y divide-stone-300">
        <!-- diisi via JS -->
      </div>
    </div>
  </section>

  <!-- Orders Tab -->
  <section id="panel-orders" class="hidden">
    <div class="rounded-2xl p-6 border border-stone-300 bg-[#fbf8f5]">
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-stone-900">All Orders</h3>
        <p class="text-sm text-stone-600">Click an order to view items</p>
      </div>
      <div id="orders-list" class="space-y-6"></div>
    </div>
  </section>

  <!-- Bookings Tab -->
  <section id="panel-bookings" class="hidden">
    <div class="overflow-x-auto bg-[#ede9de] border border-stone-300 rounded-xl p-4">
      <table class="w-full text-left">
        <thead class="border-b border-stone-300">
          <tr>
            <th class="py-3 px-4 font-semibold">Booking ID</th>
            <th class="py-3 px-4 font-semibold">Student</th>
            <th class="py-3 px-4 font-semibold">Class</th>
            <th class="py-3 px-4 font-semibold">Instructor</th>
            <th class="py-3 px-4 font-semibold">Date & Time</th>
            <th class="py-3 px-4 font-semibold">Status</th>
          </tr>
        </thead>
        <tbody id="bookings-body" class="divide-y divide-stone-300"></tbody>
      </table>
    </div>
  </section>

  <!-- Users Tab -->
  <section id="panel-users" class="hidden">
    <div class="mb-4 flex items-center gap-2">
      <input id="user-search" type="text" placeholder="Search username…" class="w-full md:w-80 rounded-lg border border-stone-300 px-3 py-2">
      <button id="user-search-btn" class="px-4 py-2 rounded-lg bg-stone-900 text-white">Search</button>
    </div>
    <div class="overflow-x-auto bg-[#ede9de] border border-stone-300 rounded-xl p-4">
      <table class="w-full text-left">
        <thead class="border-b border-stone-300">
          <tr>
            <th class="py-3 px-4 font-semibold">User ID</th>
            <th class="py-3 px-4 font-semibold">Username</th>
            <th class="py-3 px-4 font-semibold">Phone</th>
            <th class="py-3 px-4 font-semibold">Join Date</th>
            <th class="py-3 px-4 font-semibold">Orders</th>
            <th class="py-3 px-4 font-semibold">Bookings</th>
            <th class="py-3 px-4 font-semibold">Status</th>
          </tr>
        </thead>
        <tbody id="users-body" class="divide-y divide-stone-300"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  // util kelas status
  function pill(status) {
    const s = String(status || "").toLowerCase();

    if (s === "completed" || s === "active") {
      return `
        <span
          class="inline-flex items-center justify-center px-4 py-1.5 rounded-full
                 bg-[#DFEAD7] text-[#6F7F6F] border border-[#97A590]
                 text-sm font-semibold tracking-wide">
          ${status}
        </span>
      `;
    }

    const map = {
      upcoming: "bg-yellow-100 text-yellow-800 border border-yellow-300",
      pending: "bg-yellow-100 text-yellow-800 border border-yellow-300",
      cancelled: "bg-red-100 text-red-800 border border-red-300",
      inactive: "bg-red-100 text-red-800 border border-red-300",
      default: "bg-stone-100 text-stone-800 border border-stone-300",
    };
    const cls = map[s] || map.default;

    return `<span class="inline-flex items-center justify-center px-3 py-1.5 rounded-full ${cls} text-xs font-semibold">${status}</span>`;
  }

  // Tabs
  const tabs = document.querySelectorAll(".tab-btn");
  const panels = {
    overview: document.getElementById("panel-overview"),
    orders: document.getElementById("panel-orders"),
    bookings: document.getElementById("panel-bookings"),
    users: document.getElementById("panel-users"),
  };
  tabs.forEach(btn => {
    btn.addEventListener("click", () => {
      tabs.forEach(b => b.classList.remove("text-primary","border-primary","border-b-2"));
      btn.classList.add("text-primary","border-primary","border-b-2");
      Object.values(panels).forEach(el => el.classList.add("hidden"));
      panels[btn.dataset.tab].classList.remove("hidden");
      // lazy load data per tab
      if (btn.dataset.tab === "orders") loadOrders();
      if (btn.dataset.tab === "bookings") loadBookings();
      if (btn.dataset.tab === "users") loadUsers();
    });
  });

  // Load stats + activity on first paint
  document.addEventListener("DOMContentLoaded", () => {
    loadStats();
    loadActivity();
  });

  async function loadStats() {
    const r = await fetch("{% url 'useradmin:api_stats' %}");
    const j = await r.json();
    const s = j.data;
    const el = document.getElementById("stats");
    el.innerHTML = `
      ${statCard("Total Users", s.total_users)}
      ${statCard("Total Income", "Rp " + formatRp(s.total_income))}
      ${statCard("Total Orders", s.total_orders)}
      ${statCard("Total Bookings", s.total_bookings)}
    `;
  }

function statCard(label, value) {
  return `
    <div class="bg-[#ede9de] hover:bg-[#e4dfd2] transition-colors border border-stone-300 rounded-xl p-6">
      <p class="text-xs uppercase tracking-wider text-stone-700 font-semibold mb-1">${label}</p>
      <p class="text-3xl md:text-4xl font-bold text-stone-900 leading-tight">${value}</p>
    </div>
  `;
}

  async function loadActivity() {
    const r = await fetch("{% url 'useradmin:api_activity' %}");
    const j = await r.json();
    const el = document.getElementById("recent-activity");
    el.innerHTML = (j.activity || []).map(a => `
      <div class="py-3 flex items-center justify-between">
        <div>
          <p class="font-medium text-stone-900">${a.title}</p>
          <p class="text-sm text-stone-500">${a.subtitle || ""}</p>
        </div>
        ${pill(a.status)}
      </div>
    `).join("");
  }

  async function loadOrders() {
    const r = await fetch("{% url 'useradmin:api_orders' %}");
    const j = await r.json();
    const list = document.getElementById("orders-list");
    const orders = j.orders || [];

    list.innerHTML = orders.map(o => {
      const cardId = `order-${o.id}`;
      return `
        <div class="rounded-2xl border border-stone-200 bg-[#ede9de] shadow-sm">
          <button type="button"
                  class="w-full flex flex-wrap items-center justify-between gap-3 px-5 py-4 border-b border-stone-300 hover:bg-[#e4dfd2] transition"
                  data-toggle="#${cardId}">
            <div>
              <p class="text-sm text-stone-500">Order ID</p>
              <p class="font-semibold tracking-wide">#${o.id}</p>
            </div>  
            <div>
              <p class="text-sm text-stone-500">Customer</p>
              <p class="font-medium">${o.user_name}</p>
            </div>
            <div>
              <p class="text-sm text-stone-500">Date</p>
              <p class="font-medium">${o.date}</p>
            </div>
            <div class="text-right">
              <p class="text-sm text-stone-500">Total</p>
              <p class="text-lg font-semibold">Rp ${Number(o.amount||0).toLocaleString("id-ID")}</p>
            </div>
            <div class="flex items-center gap-2">
              ${pill(o.status)}
              <svg class="w-5 h-5 text-stone-600 transition-transform" data-chevron viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 9l6 6 6-6"/>
              </svg>
            </div>
          </button>

          <div id="${cardId}" class="px-5 py-4 hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-left">
                <thead>
                  <tr class="text-sm text-stone-500 border-b border-stone-300">
                    <th class="py-2 pr-3">Item</th>
                    <th class="py-2 pr-3">Qty</th>
                    <th class="py-2 pr-3">Price</th>
                    <th class="py-2 pr-0 text-right">Subtotal</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-stone-300">
                  ${(o.line_items || []).map(it => `
                    <tr class="align-top">
                      <td class="py-3 pr-3"><div class="font-medium">${it.name}</div></td>
                      <td class="py-3 pr-3">${it.qty}</td>
                      <td class="py-3 pr-3">Rp ${Number(it.price||0).toLocaleString("id-ID")}</td>
                      <td class="py-3 pr-0 text-right">Rp ${Number(it.subtotal||0).toLocaleString("id-ID")}</td>
                    </tr>
                  `).join("")}
                  ${(!o.line_items || o.line_items.length===0) ? `
                    <tr><td colspan="4" class="py-4 text-sm text-stone-500">No items for this order.</td></tr>` : ""
                  }
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }).join("");

    bindOrderToggles();
  }

  function bindOrderToggles() {
    document.querySelectorAll('#panel-orders [data-toggle]').forEach(btn => {
      btn.addEventListener('click', () => {
        const sel = btn.getAttribute('data-toggle');
        const panel = document.querySelector(sel);
        if (!panel) return;
        const chevron = btn.querySelector('[data-chevron]');
        panel.classList.toggle('hidden');
        if (chevron) {
          chevron.style.transform = panel.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        }
      }, { once: false });
    });
  }

  async function loadBookings() {
    const r = await fetch("{% url 'useradmin:api_bookings' %}");
    const j = await r.json();
    const el = document.getElementById("bookings-body");
    el.innerHTML = (j.bookings || []).map(b => `
      <tr class="border-b border-stone-300 hover:bg-[#e4dfd2] transition">
        <td class="py-3 px-4 font-light">#${b.id}</td>
        <td class="py-3 px-4">${b.user_name}</td>
        <td class="py-3 px-4 text-sm">${b.class_name}</td>
        <td class="py-3 px-4">${b.instructor || ""}</td>
        <td class="py-3 px-4">
          <div>
            <p>${b.date}</p>
            <p class="text-sm text-stone-500">${b.time}</p>
          </div>
        </td>
        <td class="py-3 px-4">${pill(b.status)}</td>
      </tr>
    `).join("");
  }

  async function loadUsers(q="") {
    const url = new URL("{% url 'useradmin:api_users' %}", window.location.origin);
    if (q) url.searchParams.set("q", q);
    const r = await fetch(url);
    const j = await r.json();
    const el = document.getElementById("users-body");
    el.innerHTML = (j.users || []).map(u => `
      <tr class="border-b border-stone-300 hover:bg-[#e4dfd2] transition">
        <td class="py-3 px-4 font-light">#${u.id}</td>
        <td class="py-3 px-4 font-semibold">${u.username}</td>
        <td class="py-3 px-4 text-sm">${u.phone || "-"}</td>
        <td class="py-3 px-4">${u.join_date}</td>
        <td class="py-3 px-4 text-center">${u.total_orders}</td>
        <td class="py-3 px-4 text-center">${u.total_bookings}</td>
        <td class="py-3 px-4">${pill(u.status)}</td>
      </tr>
    `).join("");
  }

  document.getElementById("user-search-btn")?.addEventListener("click", () => {
    const q = document.getElementById("user-search").value.trim();
    loadUsers(q);
  });

  function formatRp(n) {
    const f = parseFloat(n || "0");
    return f.toLocaleString("id-ID", { maximumFractionDigits: 0 });
  }
</script>
{% endblock %}

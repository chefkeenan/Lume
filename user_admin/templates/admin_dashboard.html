{% extends "base.html" %}
{% load static humanize %}

{% block title %}Admin Dashboard — Lume{% endblock %}

{% block content %}
<header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-stone-200">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
    <a href="/" class="font-semibold">Lume</a>
    <nav class="text-sm text-stone-600">Admin &rsaquo; Dashboard</nav>
  </div>
</header>

<main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10">
  <div class="mb-10">
    <h1 class="text-4xl font-light text-stone-900 mb-2">Admin Dashboard</h1>
    <p class="text-stone-600">Manage orders, bookings, users, and view analytics</p>
  </div>

  <!-- Stats -->
  <div id="stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
    <!-- diisi via JS -->
  </div>

  <!-- Tabs -->
  <div class="flex gap-4 mb-6 border-b border-stone-200 overflow-x-auto" id="tabs">
    <button data-tab="overview" class="tab-btn px-4 py-3 font-semibold text-primary border-b-2 border-primary">Overview</button>
    <button data-tab="orders"   class="tab-btn px-4 py-3 font-semibold text-stone-500 hover:text-stone-800">Orders</button>
    <button data-tab="bookings" class="tab-btn px-4 py-3 font-semibold text-stone-500 hover:text-stone-800">Bookings</button>
    <button data-tab="users"    class="tab-btn px-4 py-3 font-semibold text-stone-500 hover:text-stone-800">Users</button>
  </div>

  <!-- Panels -->
  <section id="panel-overview" class="space-y-8">
    <div class="bg-white border border-stone-200 rounded-xl p-6">
      <h2 class="text-2xl font-light text-stone-900 mb-4">Recent Activity</h2>
      <div id="recent-activity" class="divide-y divide-stone-200">
        <!-- diisi via JS -->
      </div>
    </div>
  </section>

  <section id="panel-orders" class="hidden">
    <div class="overflow-x-auto bg-white border border-stone-200 rounded-xl">
      <table class="w-full text-left">
        <thead class="border-b border-stone-200">
          <tr>
            <th class="py-3 px-4 font-semibold">Order ID</th>
            <th class="py-3 px-4 font-semibold">Customer</th>
            <th class="py-3 px-4 font-semibold">Items</th>
            <th class="py-3 px-4 font-semibold">Amount</th>
            <th class="py-3 px-4 font-semibold">Date</th>
            <th class="py-3 px-4 font-semibold">Status</th>
          </tr>
        </thead>
        <tbody id="orders-body" class="divide-y divide-stone-100"></tbody>
      </table>
    </div>
  </section>

  <section id="panel-bookings" class="hidden">
    <div class="overflow-x-auto bg-white border border-stone-200 rounded-xl">
      <table class="w-full text-left">
        <thead class="border-b border-stone-200">
          <tr>
            <th class="py-3 px-4 font-semibold">Booking ID</th>
            <th class="py-3 px-4 font-semibold">Student</th>
            <th class="py-3 px-4 font-semibold">Class</th>
            <th class="py-3 px-4 font-semibold">Instructor</th>
            <th class="py-3 px-4 font-semibold">Date & Time</th>
            <th class="py-3 px-4 font-semibold">Status</th>
          </tr>
        </thead>
        <tbody id="bookings-body" class="divide-y divide-stone-100"></tbody>
      </table>
    </div>
  </section>

  <section id="panel-users" class="hidden">
    <div class="mb-4 flex items-center gap-2">
      <input id="user-search" type="text" placeholder="Search username…" class="w-full md:w-80 rounded-lg border border-stone-300 px-3 py-2">
      <button id="user-search-btn" class="px-4 py-2 rounded-lg bg-stone-900 text-white">Search</button>
    </div>
    <div class="overflow-x-auto bg-white border border-stone-200 rounded-xl">
      <table class="w-full text-left">
        <thead class="border-b border-stone-200">
          <tr>
            <th class="py-3 px-4 font-semibold">User ID</th>
            <th class="py-3 px-4 font-semibold">Username</th>
            <th class="py-3 px-4 font-semibold">Email</th>
            <th class="py-3 px-4 font-semibold">Phone</th>
            <th class="py-3 px-4 font-semibold">Join Date</th>
            <th class="py-3 px-4 font-semibold">Orders</th>
            <th class="py-3 px-4 font-semibold">Bookings</th>
            <th class="py-3 px-4 font-semibold">Status</th>
          </tr>
        </thead>
        <tbody id="users-body" class="divide-y divide-stone-100"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  // util kelas status
  function pill(status) {
    const map = {
      completed: "bg-green-100 text-green-800",
      active: "bg-green-100 text-green-800",
      upcoming: "bg-yellow-100 text-yellow-800",
      pending: "bg-yellow-100 text-yellow-800",
      cancelled: "bg-red-100 text-red-800",
      inactive: "bg-red-100 text-red-800",
      default: "bg-stone-100 text-stone-800",
    };
    const cls = map[status] || map.default;
    return `<span class="px-3 py-1 rounded-full text-xs font-semibold ${cls}">${status}</span>`;
  }

  // Tabs
  const tabs = document.querySelectorAll(".tab-btn");
  const panels = {
    overview: document.getElementById("panel-overview"),
    orders: document.getElementById("panel-orders"),
    bookings: document.getElementById("panel-bookings"),
    users: document.getElementById("panel-users"),
  };
  tabs.forEach(btn => {
    btn.addEventListener("click", () => {
      tabs.forEach(b => b.classList.remove("text-primary","border-primary","border-b-2"));
      btn.classList.add("text-primary","border-primary","border-b-2");
      Object.values(panels).forEach(el => el.classList.add("hidden"));
      panels[btn.dataset.tab].classList.remove("hidden");
      // lazy load data per tab
      if (btn.dataset.tab === "orders") loadOrders();
      if (btn.dataset.tab === "bookings") loadBookings();
      if (btn.dataset.tab === "users") loadUsers();
    });
  });

  // Load stats + activity on first paint
  document.addEventListener("DOMContentLoaded", () => {
    loadStats();
    loadActivity();
  });

  async function loadStats() {
    const r = await fetch("{% url 'useradmin:api_stats' %}");
    const j = await r.json();
    const s = j.data;
    const el = document.getElementById("stats");
    el.innerHTML = `
      ${statCard("Total Users", s.total_users, "bg-blue-100 text-blue-800")}
      ${statCard("Total Income", "Rp " + formatRp(s.total_income), "bg-green-100 text-green-800")}
      ${statCard("Total Orders", s.total_orders, "bg-orange-100 text-orange-800")}
      ${statCard("Total Bookings", s.total_bookings, "bg-purple-100 text-purple-800")}
    `;
  }

  function statCard(label, value, color) {
    return `
      <div class="bg-white border border-stone-200 rounded-xl p-6">
        <div class="w-12 h-12 rounded-lg ${color} flex items-center justify-center mb-3">
          <span class="text-sm font-semibold">${label.split(' ')[0][0]}</span>
        </div>
        <p class="text-stone-500 text-sm mb-1">${label}</p>
        <p class="text-2xl font-light text-stone-900">${value}</p>
      </div>
    `;
  }

  async function loadActivity() {
    const r = await fetch("{% url 'useradmin:api_activity' %}");
    const j = await r.json();
    const el = document.getElementById("recent-activity");
    el.innerHTML = (j.activity || []).map(a => `
      <div class="py-3 flex items-center justify-between">
        <div>
          <p class="font-medium text-stone-900">${a.title}</p>
          <p class="text-sm text-stone-500">${a.subtitle || ""}</p>
        </div>
        ${pill(a.status)}
      </div>
    `).join("");
  }

  async function loadOrders() {
    const r = await fetch("{% url 'useradmin:api_orders' %}");
    const j = await r.json();
    const el = document.getElementById("orders-body");
    el.innerHTML = (j.orders || []).map(o => `
      <tr class="hover:bg-stone-50 transition">
        <td class="py-3 px-4 font-light">#${o.id}</td>
        <td class="py-3 px-4">
          <p class="font-semibold">${o.user_name}</p>
          <p class="text-sm text-stone-500">${o.user_email || ""}</p>
        </td>
        <td class="py-3 px-4 text-sm">${o.items}</td>
        <td class="py-3 px-4 text-stone-900">Rp ${formatRp(o.amount)}</td>
        <td class="py-3 px-4">${o.date}</td>
        <td class="py-3 px-4">${pill(o.status)}</td>
      </tr>
    `).join("");
  }

  async function loadBookings() {
    const r = await fetch("{% url 'useradmin:api_bookings' %}");
    const j = await r.json();
    const el = document.getElementById("bookings-body");
    el.innerHTML = (j.bookings || []).map(b => `
      <tr class="hover:bg-stone-50 transition">
        <td class="py-3 px-4 font-light">#${b.id}</td>
        <td class="py-3 px-4">${b.user_name}</td>
        <td class="py-3 px-4 text-sm">${b.class_name}</td>
        <td class="py-3 px-4">${b.instructor || ""}</td>
        <td class="py-3 px-4">
          <div>
            <p>${b.date}</p>
            <p class="text-sm text-stone-500">${b.time}</p>
          </div>
        </td>
        <td class="py-3 px-4">${pill(b.status)}</td>
      </tr>
    `).join("");
  }

  async function loadUsers(q="") {
    const url = new URL("{% url 'useradmin:api_users' %}", window.location.origin);
    if (q) url.searchParams.set("q", q);
    const r = await fetch(url);
    const j = await r.json();
    const el = document.getElementById("users-body");
    el.innerHTML = (j.users || []).map(u => `
      <tr class="hover:bg-stone-50 transition">
        <td class="py-3 px-4 font-light">#${u.id}</td>
        <td class="py-3 px-4 font-semibold">${u.username}</td>
        <td class="py-3 px-4 text-sm">${u.email || ""}</td>
        <td class="py-3 px-4 text-sm">${u.phone || "-"}</td>
        <td class="py-3 px-4">${u.join_date}</td>
        <td class="py-3 px-4 text-center">${u.total_orders}</td>
        <td class="py-3 px-4 text-center">${u.total_bookings}</td>
        <td class="py-3 px-4">${pill(u.status)}</td>
      </tr>
    `).join("");
  }

  document.getElementById("user-search-btn")?.addEventListener("click", () => {
    const q = document.getElementById("user-search").value.trim();
    loadUsers(q);
  });

  function formatRp(n) {
    // n string "12345.00" -> 12.345
    const f = parseFloat(n || "0");
    return f.toLocaleString("id-ID", { maximumFractionDigits: 0 });
  }
</script>
{% endblock %}

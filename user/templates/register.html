{% extends "base.html" %}
{% load static %}

{% block content %}
<main class="mx-auto max-w-7xl px-6 py-10">
  <div class="mx-auto max-w-md rounded-2xl border border-black/10 bg-[#ede9de] shadow-2xl p-6 sm:p-8">
    <h1 class="mb-6 text-center text-3xl font-extrabold tracking-tight text-[#0E0E0E]">Register New Account</h1>

    <form method="post" action="{% url 'user:register' %}" class="space-y-5" id="registerForm" novalidate>
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="rounded-lg bg-red-50 px-3 py-2 text-sm text-red-700">
          {{ form.non_field_errors }}
        </div>
      {% endif %}


      <div>
        <label class="mb-2 block text-sm font-semibold text-stone-700">Username</label>
        <input type="text" name="username" value="{{ form.username.value|default_if_none:'' }}"
               autocomplete="username"
               class="w-full rounded-xl border border-black/10 bg-white px-4 py-3 outline-none focus:border-black/20"
               placeholder="Choose a username" required />
        {% if form.username.errors %}
          <p class="mt-2 text-sm text-red-600">{{ form.username.errors.0 }}</p>
        {% endif %}
        <p id="err-username" class="mt-2 text-sm text-red-600 hidden"></p>
      </div>

      <div>
        <label class="mb-2 block text-sm font-semibold text-stone-700">Phone</label>
        <input type="text" name="phone" value="{{ form.phone.value|default_if_none:'' }}"
               autocomplete="tel"
               class="w-full rounded-xl border border-black/10 bg-white px-4 py-3 outline-none focus:border-black/20"
               placeholder="Your phone number" required />
        {% if form.phone.errors %}
          <p class="mt-2 text-sm text-red-600">{{ form.phone.errors.0 }}</p>
        {% endif %}
        <p id="err-phone" class="mt-2 text-sm text-red-600 hidden"></p>
      </div>

      <div>
        <label class="mb-2 block text-sm font-semibold text-stone-700">Password</label>
        <div class="relative">
          <input id="regPasswordInput" type="password" name="password1"
                 autocomplete="new-password"
                 class="w-full rounded-xl border border-black/10 bg-white px-4 py-3 pr-10 outline-none focus:border-black/20"
                 placeholder="Create a password" required />
          <button type="button" id="toggleRegPw"
                  class="absolute inset-y-0 right-2 my-auto h-8 w-8 rounded-full text-stone-500 hover:bg-black/5"
                  aria-label="Toggle password">üëÅÔ∏è</button>
        </div>
        {% if form.password1.errors %}
          <p class="mt-2 text-sm text-red-600">{{ form.password1.errors.0 }}</p>
        {% endif %}
        <p id="err-password1" class="mt-2 text-sm text-red-600 hidden"></p>
      </div>

      <div>
        <label class="mb-2 block text-sm font-semibold text-stone-700">Confirm Password</label>
        <div class="relative">
          <input id="regPasswordConfirm" type="password" name="password2"
                 autocomplete="new-password"
                 class="w-full rounded-xl border border-black/10 bg-white px-4 py-3 pr-10 outline-none focus:border-black/20"
                 placeholder="Re-enter your password" required />
          <button type="button" id="toggleRegPw2"
                  class="absolute inset-y-0 right-2 my-auto h-8 w-8 rounded-full text-stone-500 hover:bg-black/5"
                  aria-label="Toggle password">üëÅÔ∏è</button>
        </div>
        <p id="pwError" class="mt-2 hidden text-sm font-medium text-red-600">Passwords do not match.</p>
        {% if form.password2.errors %}
          <p class="mt-2 text-sm text-red-600">{{ form.password2.errors.0 }}</p>
        {% endif %}
        <p id="err-password2" class="mt-2 text-sm text-red-600 hidden"></p>
      </div>

      <p id="err-__all__" class="mt-2 text-sm text-red-600 hidden"></p>
      <button type="submit"
              class="w-full rounded-full bg-[#A7B29C] px-4 py-3 text-base font-semibold text-white shadow-[inset_0_-4px_10px_rgba(0,0,0,0.15)] hover:opacity-95 active:scale-[.99]">
        Register
      </button>

      <p class="text-center text-sm text-stone-700">
        Already have an account?
        <a href="{% url 'user:login' %}" class="font-semibold underline-offset-2 hover:underline">Log in here</a>
      </p>
    </form>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const form = document.getElementById('registerForm');
    const pw1 = document.getElementById('regPasswordInput');
    const pw2 = document.getElementById('regPasswordConfirm');
    const errMatch = document.getElementById('pwError');
    const t1 = document.getElementById('toggleRegPw');
    const t2 = document.getElementById('toggleRegPw2');

    function toggle(el, btn) {
      el.type = el.type === 'password' ? 'text' : 'password';

      if (el.type === 'text') {
        el.style.webkitTextSecurity = 'none';
        if (btn) btn.textContent = 'üëÅ';
      } else {
        el.style.webkitTextSecurity = '';
        if (btn) btn.textContent = 'üëÅ';
      }

      el.focus();
      const v = el.value;
      el.value = '';
      el.value = v;
    }
    if (t1 && pw1) t1.addEventListener('click', (e)=>{ e.preventDefault(); toggle(pw1, t1); });
    if (t2 && pw2) t2.addEventListener('click', (e)=>{ e.preventDefault(); toggle(pw2, t2); });

    function checkMatch() {
      const match = pw1.value === pw2.value;
      errMatch.classList.toggle('hidden', match);
      return match;
    }
    pw1.addEventListener('input', checkMatch);
    pw2.addEventListener('input', checkMatch);

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(";").shift());
    }

    function showErr(id, messages){
      const el = document.getElementById(id);
      if (!el) return;
      const html = Array.isArray(messages) ? messages.join("<br>") : String(messages);
      el.innerHTML = html;
      el.classList.remove("hidden");
    }

    function clearErr(){
      ["err-_all_", "err-username","err-phone","err-password1","err-password2"].forEach(id=>{
        const el = document.getElementById(id);
        if (el){ el.classList.add("hidden"); el.innerHTML = ""; }
      });
    }

    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      if (!checkMatch()) {
        return;
      }

      clearErr();

      const fd = new FormData(form);
      fd.set("ajax", "1");

      const csrftoken = getCookie("csrftoken") || "";

      const res = await fetch(form.action, {
        method: "POST",
        headers: {
          "X-Requested-With":"XMLHttpRequest",
          "X-CSRFToken": csrftoken,
        },
        body: fd,
        credentials: "same-origin", 
      });

      const ct = res.headers.get("content-type") || "";
      if (!ct.includes("application/json")) {
        showErr("err-_all_", "Registration failed. Please try again.");
        return;
      }

      const data = await res.json().catch(()=> ({}));

      if (res.ok && data.ok) {
        localStorage.setItem("postRedirectToast", JSON.stringify({
          type: "success",
          text: data.message || "Registration successful."
        }));
        window.location.href = data.redirect_url || "/";
        return;
      }

      const errs = data.errors || {};
      if (errs._all)   showErr("err-all", errs.all_);
      if (errs.username)  showErr("err-username", errs.username);
      if (errs.phone)     showErr("err-phone", errs.phone);
      if (errs.password1) showErr("err-password1", errs.password1);
      if (errs.password2) showErr("err-password2", errs.password2);

      if (data.non_field_errors) showErr("err-_all_", data.non_field_errors);
    });
  })();
</script>
{%¬†endblock¬†%}
{% extends "base.html" %}
{% load static %}
{% block title %}Your Cart ‚Äî Lume{% endblock %}

{% block content %}
<section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">

  <!-- Back to home -->
  <div class="mb-6">
    <a href="{% url 'main:landing' %}"
       class="inline-flex items-center gap-2 rounded-full bg-[#E7E2D6] px-4 py-2 text-sm text-[#3A342D] hover:bg-[#DCD4C4]">
      <span class="inline-block -ml-1">‚Üê</span>
      <span>Back to Home</span>
    </a>
  </div>

  <!-- Title -->
  <div class="mb-8">
    <h1 class="text-4xl font-extrabold tracking-tight text-[#3A342D]">Your Cart</h1>
    <p class="mt-2 text-[#766E62]">Review your items before checkout.</p>
  </div>

  <!-- Layout -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- LEFT: Items -->
    <div class="lg:col-span-2 space-y-4">

      <!-- NEW: select toolbar -->
      <div class="flex items-center justify-between">
        <div class="text-sm text-[#766E62]">
          Selection
        </div>
        <div class="flex items-center gap-2">
          <button id="selectAllBtn"
                  class="px-3 py-1.5 text-sm rounded-lg border border-[#E0D9CA] text-[#3A342D] hover:bg-[#F5F2EB]">
            Select all
          </button>
          <button id="unselectAllBtn"
                  class="px-3 py-1.5 text-sm rounded-lg border border-[#E0D9CA] text-[#3A342D] hover:bg-[#F5F2EB]">
            Unselect all
          </button>
        </div>
      </div>
      <!-- /toolbar -->

      <div id="cartItems" style="display:none"></div>

      <!-- Empty State -->
      <div id="emptyState" class="text-center py-20" style="display:block">
        <p class="text-lg font-medium text-[#766E62]">Your cart is empty.</p>
      </div>
    </div>

    <!-- RIGHT: Summary -->
    <aside class="lg:col-span-1">
      <div class="sticky top-6 rounded-2xl bg-[#F5F2EB] border border-[#E8E3D8] p-6">
        <h2 class="text-xl font-bold text-[#3A342D] mb-6">Order Summary</h2>

        <div class="space-y-4 mb-6">
          <div class="flex items-center justify-between">
            <span class="text-[#766E62]">Total Items</span>
            <span class="font-semibold text-[#3A342D]" data-total-items>0</span>
          </div>
        </div>

        <div class="space-y-3">
          <form id="checkoutForm" method="post" action="{% url 'checkout:cart_checkout_page' %}">
            {% csrf_token %}
            <input type="hidden" name="item_ids" id="selectedItemIds">
            <button type="submit" id="checkoutBtn"
              class="w-full rounded-xl bg-[#B8A88A] text-white py-3.5 text-sm font-semibold hover:bg-[#A89776] transition disabled:opacity-60 disabled:cursor-not-allowed"
              disabled>
              Proceed to Checkout ‚Üí
            </button>
          </form>

          <a href="{% url 'main:show_main' %}"
             class="block w-full rounded-xl border border-[#E0D9CA] py-2.5 text-center text-sm text-[#3A342D] hover:bg-[#F5F2EB]">
            Continue Shopping
          </a>
        </div>
      </div>
    </aside>

  </div>
</section>

<!-- Template untuk product card -->
<template id="cart-item-template">
  <div class="rounded-2xl bg-[#F5F2EB] border border-[#E8E3D8] p-5 hover:shadow-md transition" data-item-row>
    <div class="flex items-center gap-4">
      <input type="checkbox"
        class="h-5 w-5 rounded border-2 border-[#B8A88A] text-[#B8A88A] focus:ring-[#B8A88A] cursor-pointer flex-shrink-0"
        data-select>

      <img data-img class="h-20 w-20 rounded-xl object-cover border border-[#E8E3D8]" alt="">

      <div class="flex-1 min-w-0">
        <h3 data-name class="text-base font-semibold text-[#3A342D] truncate mb-1"></h3>
        <p data-price class="text-sm text-[#766E62]"></p>
      </div>

      <div class="flex items-center gap-3 flex-shrink-0">
        <button data-dec class="h-8 w-8 rounded-lg border-2 border-[#E8E3D8] bg-white text-[#3A342D] font-semibold hover:bg-[#F5F2EB] transition flex items-center justify-center">‚àí</button>
        <span data-qty class="w-8 text-center text-sm font-semibold text-[#3A342D]">1</span>
        <button data-inc class="h-8 w-8 rounded-lg border-2 border-[#E8E3D8] bg-white text-[#3A342D] font-semibold hover:bg-[#F5F2EB] transition flex items-center justify-center">+</button>
      </div>

      <button data-remove class="ml-2 text-red-500 hover:text-red-600 hover:scale-110 transition flex-shrink-0">üóë</button>
    </div>
  </div>
</template>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const TPL = document.getElementById('cart-item-template');
  const PLACEHOLDER_URL = "{% static 'img/placeholder.webp' %}";
  const checkoutBtn = document.getElementById('checkoutBtn');

  // CSRF
  function getCookie(name){
    let v=null;if(document.cookie!==''){for(const c of document.cookie.split(';')){
      const cc=c.trim(); if(cc.startsWith(name+'=')){v=decodeURIComponent(cc.slice(name.length+1));break;}
    }} return v;
  }
  const CSRF = getCookie('csrftoken');

  async function getJSON(url){
    const r = await fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}});
    return await r.json();
  }
  async function postForm(url, bodyObj){
    const body = new URLSearchParams(bodyObj||{});
    const r = await fetch(url, {
      method:'POST',
      headers:{'X-CSRFToken': CSRF, 'X-Requested-With':'XMLHttpRequest'},
      body
    });
    return await r.json();
  }

  function toggleEmpty(show){
    const list = document.getElementById('cartItems');
    const empty = document.getElementById('emptyState');
    if (!list || !empty) return;
    empty.style.display = show ? 'block' : 'none';
    list.style.display  = show ? 'none'  : 'block';
    if (show) setCheckoutDisabled(true);
  }

  function setTotals(totalItems){
    document.querySelectorAll('[data-total-items]').forEach(el => el.textContent = totalItems);
  }

  function setCheckoutDisabled(disabled){
    if (checkoutBtn) checkoutBtn.disabled = !!disabled;
  }

  function updateCheckoutStateFromDOM(){
    const anyRow = document.querySelector('[data-item-row]') !== null;
    const anyChecked = document.querySelector('[data-item-row] input[type="checkbox"][data-select]:checked') !== null;
    setCheckoutDisabled(!anyRow || !anyChecked);
  }

  function renderItems(items){
    const list = document.getElementById('cartItems');
    if (!items?.length){
      list.innerHTML = '';
      toggleEmpty(true);
      return;
    }
    toggleEmpty(false);
    list.innerHTML = '';

    items.forEach(it => {
      const node = TPL.content.cloneNode(true);
      const row = node.querySelector('[data-item-row]');
      row.dataset.itemId = it.id;

      const checkbox = node.querySelector('[data-select]');
      checkbox.checked = !!it.is_selected;

      const img = node.querySelector('[data-img]');
      img.src = it.thumbnail || PLACEHOLDER_URL;
      img.alt = it.product_name;
      img.onerror = () => { img.onerror=null; img.src = PLACEHOLDER_URL; };

      node.querySelector('[data-name]').textContent  = it.product_name;
      node.querySelector('[data-price]').textContent = `Rp ${Number(it.price).toLocaleString('id-ID')}`;
      node.querySelector('[data-qty]').textContent   = it.quantity;

      list.appendChild(node);
    });

    updateCheckoutStateFromDOM();
  }

  async function loadCart(){
    try{
      const data = await getJSON("{% url 'cart:json' %}");
      if (data?.ok){
        renderItems(data.items);
        setTotals(data.total_items);
      } else {
        toggleEmpty(true);
        setTotals(0);
      }
    }catch(err){
      console.error(err);
      toggleEmpty(true);
      setTotals(0);
    }
  }

  // Select all
document.getElementById('selectAllBtn')?.addEventListener('click', async ()=>{
  const out = await postForm("{% url 'cart:select_all' %}");
  if (!out.ok && window.showToast) showToast("Failed to select all items.", "error");
  if (out.total_items !== undefined) setTotals(out.total_items); 
  await loadCart();
  updateCheckoutStateFromDOM();
});

// Unselect all
document.getElementById('unselectAllBtn')?.addEventListener('click', async ()=>{
  const out = await postForm("{% url 'cart:unselect_all' %}");
  if (!out.ok && window.showToast) showToast("Failed to unselect items.", "error");
  if (out.total_items !== undefined) setTotals(out.total_items); 
  await loadCart();
  updateCheckoutStateFromDOM();
});


  // Event Delegation (row actions)
  document.addEventListener('click', async (e)=>{
    const row = e.target.closest('[data-item-row]');
    const refreshAfter = () => { updateCheckoutStateFromDOM(); };

    // toggle select
    if (e.target.matches('[data-select]')){
      const id = row?.dataset.itemId;
      const val = e.target.checked ? '1' : '0';
      const out = await postForm("{% url 'cart:toggle_select' 0 %}".replace('0', id), {is_selected: val});
      if (!out.ok){
        e.target.checked = !e.target.checked;
        if (window.showToast) showToast(out.message || "Failed to update selection.", "error");
      }
      refreshAfter();
      return;
    }

    if (!row) return;
    const id = row.dataset.itemId;

    // increment
    if (e.target.matches('[data-inc]')){
      const qtyEl = row.querySelector('[data-qty]');
      const next = Number(qtyEl.textContent) + 1;
      const out = await postForm("{% url 'cart:set_qty' 0 %}".replace('0', id), {quantity: next});
      if (out.ok){
        qtyEl.textContent = out.quantity;
        setTotals(out.total_items);
      } else {
        if (window.showToast) showToast(out.message || "Failed to update quantity.", "error");
      }
      return;
    }

    // decrement
    if (e.target.matches('[data-dec]')){
      const qtyEl = row.querySelector('[data-qty]');
      const next = Number(qtyEl.textContent) - 1;
      if (next < 1) return;
      const out = await postForm("{% url 'cart:set_qty' 0 %}".replace('0', id), {quantity: next});
      if (out.ok){
        if (out.quantity <= 0){
          row.remove();
          setTotals(out.total_items);
          const hasItem = !!document.querySelector('[data-item-row]');
          if (!hasItem) toggleEmpty(true);
        } else {
          qtyEl.textContent = out.quantity;
          setTotals(out.total_items);
        }
        refreshAfter();
      } else {
        if (window.showToast) showToast(out.message || "Failed to update quantity.", "error");
      }
      return;
    }

    // remove
    if (e.target.matches('[data-remove]')){
      if (!confirm('Remove this item from your cart?')) return;
      const out = await postForm("{% url 'cart:remove_ajax' 0 %}".replace('0', id));
      if (out.ok){
        row.remove();
        setTotals(out.total_items);
        const hasItem = !!document.querySelector('[data-item-row]');
        if (!hasItem) toggleEmpty(true);
        refreshAfter();
      } else {
        if (window.showToast) showToast(out.message || "Failed to remove item.", "error");
      }
      return;
    }
  });

  // Checkout
  document.getElementById('checkoutForm')?.addEventListener('submit', (e)=>{
    // disallow submit kalau disabled atau tidak ada yang dipilih
    if (checkoutBtn?.disabled){
      e.preventDefault();
      if (window.showToast) showToast("Please select at least one item to proceed.", "warning");
      return;
    }
    // kumpulkan ID yang dipilih langsung dari DOM
    const selectedIds = Array.from(
      document.querySelectorAll('[data-item-row] input[type="checkbox"][data-select]:checked')
    ).map(cb => cb.closest('[data-item-row]').dataset.itemId);

    if (selectedIds.length === 0){
      e.preventDefault();
      if (window.showToast) showToast("Please select at least one item to proceed.", "warning");
      setCheckoutDisabled(true);
      return;
    }
    document.getElementById('selectedItemIds').value = selectedIds.join(',');
  });

  // Init
  loadCart();
});
</script>
{% endblock %}

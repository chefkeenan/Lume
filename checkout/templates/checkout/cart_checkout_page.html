{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block title %}Checkout — Lume{% endblock %}

{% block content %}
<section class="mx-auto max-w-7xl px-6 lg:px-8 py-10 bg-[#F7F7F3]">

  <!-- Back to Cart -->
<a href="{% url 'cart:page' %}"
   class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm
          bg-[#ede9de] hover:bg-[#e4dfd2] transition-colors
          border border-stone-300 text-stone-800 shadow-sm
          mb-8 md:mb-10">
  <!-- arrow-left -->
  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
  </svg>
  <span>Back to Cart</span>
</a>

  <!-- Heading -->
  <h1 class="text-3xl font-semibold tracking-tight text-[#3E4038]">Checkout</h1>
  <p class="text-[#7A7C72] mt-1">Complete your purchase</p>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">

    <!-- LEFT: Form -->
    <form method="post" action="{% url 'checkout:checkout_cart_create' %}" class="lg:col-span-2 space-y-6" id="checkout-form">
      {% csrf_token %}

      <!-- Shipping Information -->
      <div class="rounded-3xl border border-[#E6E7E1] bg-[#F4F2EA] p-6 shadow-[0_6px_18px_rgba(126,128,115,0.08)]">
        <h2 class="text-lg font-medium mb-4 text-[#3E4038]">Shipping Information</h2>

        {% if form.non_field_errors %}
          <div class="mb-3 text-sm text-red-600">{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <!-- Address line 1 -->
          <div class="sm:col-span-2">
            <label for="{{ form.address_line1.id_for_label }}" class="text-sm block mb-1 text-[#3E4038]">Address</label>
            {{ form.address_line1 }}
            {% if form.address_line1.errors %}<p class="text-sm text-red-600 mt-1">{{ form.address_line1.errors|striptags }}</p>{% endif %}
          </div>

          <!-- Address line 2 -->
          <div class="sm:col-span-2">
            <label for="{{ form.address_line2.id_for_label }}" class="text-sm block mb-1 text-[#3E4038]">Address Line 2</label>
            {{ form.address_line2 }}
            {% if form.address_line2.errors %}<p class="text-sm text-red-600 mt-1">{{ form.address_line2.errors|striptags }}</p>{% endif %}
          </div>

          <!-- City -->
          <div>
            <label for="{{ form.city.id_for_label }}" class="text-sm block mb-1 text-[#3E4038]">City</label>
            {{ form.city }}
            {% if form.city.errors %}<p class="text-sm text-red-600 mt-1">{{ form.city.errors|striptags }}</p>{% endif %}
          </div>

          <!-- Province -->
          <div>
            <label for="{{ form.province.id_for_label }}" class="text-sm block mb-1 text-[#3E4038]">Province</label>
            {{ form.province }}
            {% if form.province.errors %}<p class="text-sm text-red-600 mt-1">{{ form.province.errors|striptags }}</p>{% endif %}
          </div>

          <!-- Postal -->
          <div>
            <label for="{{ form.postal_code.id_for_label }}" class="text-sm block mb-1 text-[#3E4038]">Postal Code</label>
            {{ form.postal_code }}
            {% if form.postal_code.errors %}<p class="text-sm text-red-600 mt-1">{{ form.postal_code.errors|striptags }}</p>{% endif %}
          </div>

          <!-- Country -->
          <div>
            <label for="{{ form.country.id_for_label }}" class="text-sm block mb-1 text-[#3E4038]">Country</label>
            {{ form.country }}
            {% if form.country.errors %}<p class="text-sm text-red-600 mt-1">{{ form.country.errors|striptags }}</p>{% endif %}
          </div>

          <!-- Notes -->
          <div class="sm:col-span-2">
            <label for="{{ form.notes.id_for_label }}" class="text-sm block mb-1 text-[#3E4038]">Notes</label>
            {{ form.notes }}
            {% if form.notes.errors %}<p class="text-sm text-red-600 mt-1">{{ form.notes.errors|striptags }}</p>{% endif %}
          </div>
        </div>
      </div>

      <!-- Payment (COD) -->
      <div class="rounded-3xl border border-[#E6E7E1] bg-[#F4F2EA] p-6 shadow-[0_6px_18px_rgba(126,128,115,0.08)]">
        <h2 class="text-lg font-medium mb-3 text-[#3E4038]">Payment Method</h2>
        <label class="flex items-center gap-3 rounded-2xl border border-[#D9DBD0] bg-white px-4 py-3 cursor-pointer hover:bg-[#F7F7F3]">
          <input type="radio" name="payment_method" value="COD" checked
                 class="h-4 w-4 text-[#7E8073] focus:ring-[#7E8073]">
          <span class="text-sm text-[#3E4038]">Cash on Delivery (COD)</span>
        </label>
      </div>

      <!-- Submit -->
      <button type="submit"
              class="w-full inline-flex items-center justify-center rounded-full bg-[#7E8073] px-6 py-3 text-white font-semibold
                     shadow-[0_6px_14px_rgba(126,128,115,0.25)] hover:bg-[#6F7166] active:bg-[#64665C] transition">
        Place Order
      </button>
    </form>

    <!-- RIGHT: Order Summary -->
    <aside class="lg:col-span-1">
      <div class="sticky top-6 rounded-3xl border border-[#E6E7E1] bg-white p-6 shadow-[0_6px_18px_rgba(126,128,115,0.08)]">
        <h2 class="text-lg font-medium mb-4 text-[#3E4038]">Order Summary</h2>

        {% if cart_items %}
        <details class="mb-4 rounded-xl border border-[#E6E7E1] bg-[#FAFAF7] p-3" open>
          <summary class="flex cursor-pointer items-center justify-between text-sm text-[#3E4038] list-none">
            <span class="font-medium">{{ items_count }} item{{ items_count|pluralize:"(s)" }}</span>
            <span class="text-xs text-[#7A7C72] caret">Show details</span>
          </summary>

          <div class="mt-3 space-y-2">
            {% for ci in cart_items %}
              <div class="flex items-center justify-between text-sm">
                <div class="flex items-baseline gap-2 min-w-0">
                  <span class="truncate max-w-[70%]">
                    {% firstof ci.display_name ci.product.product_name ci.product.name ci.product %}
                  </span>
                  <span class="shrink-0 text-[#7A7C72]">× {{ ci.quantity }}</span>
                </div>
                <span class="tabular-nums whitespace-nowrap">
                  Rp {{ ci.line_total|default:0|floatformat:0|intcomma }}
                </span>
              </div>
            {% endfor %}
          </div>
        </details>
        {% endif %}

        <dl class="space-y-2 text-sm text-[#3E4038]">
          <div class="flex justify-between"><dt>Subtotal</dt><dd class="tabular-nums">Rp {{ subtotal|floatformat:0|intcomma }}</dd></div>
          <div class="flex justify-between"><dt>Shipping</dt><dd class="tabular-nums">Rp {{ shipping|floatformat:0|intcomma }}</dd></div>
          <div class="my-3 h-px bg-[#E6E7E1]"></div>
          <div class="flex justify-between text-base font-semibold">
            <dt>Total</dt><dd class="tabular-nums">Rp {{ total|floatformat:0|intcomma }}</dd>
          </div>
        </dl>
      </div>
    </aside>

  </div>
</section>

<style>
  details[open] .caret::after { content:" ▲"; }
  details:not([open]) .caret::after { content:" ▾"; }
</style>

<script>
  // Anti double-click
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('checkout-form');
    if (!form) return;
    form.addEventListener('submit', function () {
      const btn = form.querySelector('button[type="submit"]');
      if (btn) { btn.disabled = true; btn.textContent = 'Processing…'; }
    });
  });
</script>
{% endblock %}
